#!/usr/bin/env python3
import os
from pathlib import Path
import glob


current: Path = Path(os.path.dirname(os.path.realpath(__file__)))
root: Path = current.parent.absolute()
music_source = root.joinpath("assets/music")
filenames = sorted( filter( os.path.isfile, glob.glob(str(music_source.joinpath("*.sid")))))

music_target = root.joinpath("src")
music_target.mkdir(parents=True, exist_ok=True)
# print(filenames)
print(f"Rendering SID conversion template...{music_source}")
output: Path = music_target.joinpath("convert_music.asm")
with open(output, mode="w") as o:
    o.write("""
/*
This file is autogenerated by bin/convert_sid.py
*/
    """)
    count: int  = 0
    for filename in filenames:
        if filename.endswith(".sid"):
            name: str = os.path.basename(filename)
            ptr: str = str(count).rjust(2,'0')
            o.write(f"""
.var music_{ptr} = LoadSid("../assets/music/{name}")
.segment SID_{ptr} [outPrg="../rsrc/{ptr}.prg"]
*=$0f00 "Music Params"
.print "location=$"+toHexString(music_{ptr}.location)
.print "init=$"+toHexString(music_{ptr}.init)
.print "play=$"+toHexString(music_{ptr}.play)
.print "size=$"+toHexString(music_{ptr}.size)
.print "name="+music_{ptr}.name
.print "------------------------------"
.byte music_{ptr}.startSong - 1 
.byte music_{ptr}.speed
.word music_{ptr}.init
.word music_{ptr}.play
*=music_{ptr}.location "Music_{ptr}"
.fill music_{ptr}.size, music_{ptr}.getData(i)
            """)
            count += 1
